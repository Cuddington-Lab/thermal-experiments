---
title: "Predicting the distribution of an invasive duckweed species"
author: "Debora"
date: "`r Sys.Date()`"
output: html_document
---

<style type="text/css">
  body{
  font-size: 15pt;
}
</style>

### Draft abstract
*Landoltia punctata* is an invasive aquatic plant that can form dense mats, which modify habitats and suppress other species. As a consequence, invasion episodes are associated with high management costs, and recreational areas and natural habitat loss. This species has spread across the US and has been recently found in Europe. Recent studies have attributed a low invasion risk in Europe due to similarities in the ecology of native and invasive species. However, considering the continental invasion extent of similar duckweeds in the US and Europe, and ecological similarities among them and native counterparts, a new examination of invasion risks is warranted. This study aimed to predict the distribution of *L. punctata* in Europe, where invasion is in early stages, and Canada, where there is an imminent risk of invasion considering recent records of occurrence approaching the Canadian border. We included 518 occurrence records and 3 bioclimatic variables based on life history characteristics, and ran several candidate Maxent models with different combinations of parameters. The best model has an adequate predictive capability, with a training set and testing set AUC of 0.9 and 0.81, respectively. This model suggests a high habitat suitability for the invasive species in most Western European countries and coastal regions of Canada, and in a few Great Lakes areas. Preventive measures to avoid *L. punctata* further spread are recommended in these locations to avoid a similar invasion scenario as seen in *L. minuta* in Europe or *L. punctata* in the US.

### Obtain occurrence records from GBIF
```{r echo=FALSE, message=FALSE, warning=FALSE}
options(java.parameters="~xmx10g")
library(raster)
library(maptools)
library(dismo)
library(maps)
library(rJava)
.jinit()

# tutorial Kim used: 
# https://cmerow.github.io/RDataScience/3_6_Teaching_Ecoinformatics.html#13_species_distribution_modeling
###set.seed(202307) #this worked well

#get data from gbif
lp <- gbif("Landoltia", "punctata", geo = T)
knitr::kable((head(lp[,c(2,109,116)])), "simple", digits = 2)
```


### Plot occurrences after cleaning up dataset 
(removing data without coordinates and duplicates)
```{r echo=FALSE, message=FALSE, warning=FALSE}
#removing data without geographic coordinates
lp <- subset(lp, !is.na(lon) & !is.na(lat))

#removing duplicates
dups <- duplicated(lp[, 1:10])
lp_clean  <-  lp[dups, ]

#visualize GBIF observations
data(wrld_simpl)
plot(wrld_simpl, col = "light gray", axes = T, main = "L. punctata GBIF occurrences")
points(lp$lon, lp$lat, col='orange', pch=20, cex=0.75)
points(lp$lon, lp$lat, col='red', cex=0.75)
```


### Add occurrences from literature 
(coordinates are not exact, most of the occurrences are based on the coordinates of a given country's capital)
```{r echo=FALSE, message=FALSE, warning=FALSE}
#subsetting by geographical region
#world <- subset(lp_clean, country == "United States" | country == "Mexico" | country == "Canada")
world <- subset(lp_clean, continent != "EUROPE")

europe <- subset(lp_clean, continent == "EUROPE")
europe <- europe[, c("lon", "lat")]

#van Valkenburg JLCH, Pot R. 2008. Landoltia punctata (G.Mey.) D.H.Les & D.J.Crawford
#(Smal kroos), nieuw voor Nederland. Gorteria 33:41–49.
netherlands <- data.frame(lon = 4.55, lat = 52.23) 

#Van den Neucker, T., & Scheers, K. (2022). Mislabelling may explain why some 
#prohibited invasive aquatic plants are still being sold in Belgium. 
#Knowledge & Management of Aquatic Ecosystems, (423), 8.
#https://www.kmae-journal.org/articles/kmae/full_html/2022/01/kmae210002/kmae210002.html
belgium <- data.frame(lon = rep(4.4699, times = 5), lat = rep(50.5039, times = 5)) 

#https://gd.eppo.int/reporting/article-4787
england <- data.frame(lon = 0.1167, lat = 51.50) 
italy <- data.frame(lon = 12.5674, lat = 41.8719) 
spain <- data.frame(lon = -3.7, lat = 40.41) 
switzerland <- data.frame(lon = 6.14, lat = 46.20)

#https://www.europlusmed.org/cdm_dataportal/taxon/a3b4b6a7-8144-42d9-92d9-c677c1352f82#distribution
finland <- data.frame(lon = 24.94, lat = 60.19)

#Nouvelle-Calédonie: https://inpn.mnhn.fr/espece/cd_nom/721797?lg=en
france <- data.frame(lon = 166.28, lat = -22.19)

#https://www.cabidigitallibrary.org/doi/full/10.1079/cabicompendium.115124#REF-DDB-203451
sweden <- data.frame(lon = 18.06, lat = 59.334591)

europe <- rbind(europe,netherlands,belgium,england,italy,spain,switzerland,finland,france,sweden)

### Transform dataframe into spatial points dataframe
coordinates(world) <- ~lon+lat
crs(world) <- crs(wrld_simpl)

coordinates(europe) <- ~lon+lat
crs(europe) <- crs(wrld_simpl)
```


### Perform spatial thinning to reduce spatial autocorrelation and divide dataset into training (world excluding Europe) and testing (Europe)
```{r echo=FALSE, message=FALSE, warning=FALSE}
### To reduce sampling bias (disproportional reporting in some areas), a single observation was sampled 
# create a raster layer with the same extent as my data
# to space occurrence records a defined distance from each other to avoid
# spatial autocorrelation is with spatial thinning (Aiello-Lammens et al. 2015)
r <- raster(world)
# set resolution of cells to  to 0.4166 degrees (equivalent to 2.5 arc min)
res(r) <- 0.1
# sample 1 observation per area
world_sampled <- gridSample(world, r, n=1)

r <- raster(europe)
# reduced resolution enough to obtain ~30 observations
res(r) <- 0.026
# sample 1 observation per area
europe_sampled <- gridSample(europe, r, n=1)

world_sampled <- as.data.frame(world_sampled)
europe_sampled <- as.data.frame(europe_sampled)

plot(wrld_simpl, axes=TRUE, col="light yellow", main = "Sampled occurrences")
legend("bottomright", legend=c("Testing", "Training"),
       col=c("orange", "blue"), cex=0.8, pch = 19)
# add observation points
points(world_sampled$lon, world_sampled$lat, col='orange', pch=20, cex=0.75)
points(europe_sampled$lon, europe_sampled$lat, col='blue', pch=20, cex=0.75)

### Divide files into training and testing datasets
pres_train <- world_sampled
pres_test <- europe_sampled
```

### Preliminary model run
Get satellite lake climate data and perform preliminary model run to check for correlations and subsequent re-selection of bioclimatic variables

Initial selection of bioclimatic variables:

- To reflect thermal dependency of duckweeds in terms of population growth:

BIO 1 = Mean annual temperature (Armitage, 2022)

BIO 7 = Annual range of temperature (Armitage, 2022)

- In addition to thermal dependency, to reflect preference for nutrient-rich waters, which are more prevalent in the summertime (Landolt & Kandeler, 1987):

BIO 10 = Mean temperature of warmest quarter

- To account for the dependency on precipitation (duckweeds are rare in places with high or very low precipitation; FNA, 2000):

BIO17 = Precipitation of Driest Quarter

BIO19 = Annual precipitation

```{r echo=FALSE, message=FALSE, warning=FALSE}
envs <- raster::brick('C:/Users/user/Desktop/rasters/bioclim_lakes_10km.tif')

#source for bio1 and bio7: https://onlinelibrary.wiley.com/doi/full/10.1111/ecog.06595#bib-0003
#https://onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1111%2Fele.13612&file=ele13612-sup-0001-Supinfo.pdf


##BIO10 = Mean Temperature of Warmest Quarter
### temperature dependency and nutrient-rich water preference
# having a preference for waters rich
#in nutrients, especially nitrogen and phosphorus
#(Landolt and Kandeler 1987).
#Landolt, E. and R. Kandeler. 1987. The family of Lemnaceae — a
#monographic study. Vol. 2: Phytochemistry, physiology,
#application, bibliography. Veröffentlichungen des Geobotnischen
#Instituts der Eidgenössischen Technischen Hochschule, Stiftung
#Rübel, Zürich 95: 1−638.

##BIO17 = Precipitation of Driest Quarter
# ability of seeds to tolerate dry weather
#Flora of North America Editorial Committee (FNA). 2000. Flora of North America north of Mexico. Vol. 22. #Magnoliophyta: Alismatidae, Arecidae, Commelinidae (in part), and Zingiberidae. Oxford Univ. Press, New York. #xxiii + 352 pp.
#https://fieldguide.mt.gov/speciesDetail.aspx?elcode=PMLEM01020

envs = envs[[c(1,7,10,17,19)]]
```


### Crop environment and create buffer
Create 200km buffer around occurrence area
```{r message=FALSE, warning=FALSE, include=FALSE}
library(sp)
coordinates(world_sampled) <- ~lon + lat
coordinates(europe_sampled) <- ~lon + lat

model.extent<-extent(min(world_sampled$lon)-10,max(world_sampled$lon)+10,
                     min(world_sampled$lat)-10,max(world_sampled$lat)+10)

modelEnv <- crop(envs,model.extent)
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
occ_buff <- buffer(world_sampled,600000, dissolve=TRUE)

# crop study area to buffer extent
studyArea <- crop(envs,extent(occ_buff))  

# mask the non buffer areas
studyArea <- mask(studyArea,occ_buff)
# output will still be a raster stack, just of the study area

# check with plot
plot(studyArea[[1]]/10, main="Buffer areas and observation points") 
points(world_sampled$lon, world_sampled$lat, pch=1, cex=0.51, col="purple")
legend("bottomright",legend=c("Buffer areas: annual mean temperature coloring", 
                            "Occurrences: purple"))
```


### Randomly sample points 
(same number as our observed points) inside the buffer to create pseudo-absences, or hypothetical areas where species was not found. Divide background dataset into training and testing
```{r echo=FALSE, message=FALSE, warning=FALSE}
backg = randomPoints(studyArea, n=518, p=world_sampled, extf=1.25)
colnames(backg) <- c("lon","lat")
group=kfold(backg, 5)
backg_train <- backg[group!=1,]
backg_test <- backg[group==1,]
```


### Run model and check variable contribution
```{r echo=TRUE, message=FALSE, warning=FALSE}
set.seed(202307)

xm4 <- maxent(modelEnv, pres_train, linear=true, quadratic=true, product=false, 
              threshold=false, hinge=false)
plot(xm4)
```


### Check potential correlations between bioclimatic variables
```{r echo=FALSE, message=FALSE, warning=FALSE}
stats <- layerStats(modelEnv, 'pearson', na.rm=T)
corr_matrix <- stats$'pearson correlation coefficient'
knitr::kable((subset(as.data.frame.table(cor(corr_matrix)), Freq < 1 & Freq > 0.8)), "simple", digits = 2)
```


### Select variables which contribute the most and are unrelated to each other
- To reflect thermal dependency of duckweeds in terms of population growth:

BIO 1 = Mean annual temperature (Armitage, 2022)

BIO 7 = Annual range of temperature (Armitage, 2022)

- To account for the dependency on precipitation (duckweeds are rare in places with high or very low precipitation; FNA, 2000):

BIO17 = Precipitation of Driest Quarter

```{r echo=FALSE, message=FALSE, warning=FALSE}
envs <- raster::brick('C:/Users/user/Desktop/rasters/bioclim_lakes_10km.tif')
envs <- envs[[c(1,7,17)]]
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
modelEnv <- crop(envs,model.extent)

#crs(world_sampled)="+proj=longlat +datum=WGS84 +no_defs "
occ_buff <- buffer(world_sampled,600000, dissolve=TRUE)

# crop study area to buffer extent
studyArea <- crop(envs,extent(occ_buff))  

# mask the non buffer areas
studyArea <- mask(studyArea,occ_buff)

backg <- randomPoints(studyArea, n=518, p=world_sampled, extf=1.25)
colnames(backg) <- c("lon","lat")
group <- kfold(backg, 5)
backg_train <- backg[group!=1,]
backg_test <- backg[group==1,]
```


### Create several candidate models using different combinations of parameters
```{r echo=TRUE, message=FALSE, warning=FALSE, results="hide"}
# https://jamiemkass.github.io/ENMeval/articles/ENMeval-2.0-vignette.html
set.seed(202308)
library(ENMeval)
e.mx.l <- ENMevaluate(occs = pres_train, envs = modelEnv, bg = backg_train,
                      occs.testing = pres_test,
                      algorithm = 'maxnet', partitions = 'block', 
                      tune.args = list(fc = c("L","LQ"), rm = seq(0.5, 4, by = 0.5)))
```


### Overall results
```{r echo=FALSE, message=FALSE, warning=FALSE}
res <- eval.results(e.mx.l)
names(res)[names(res) == "fc"] <- "Features"
names(res)[names(res) == "rm"] <- "Regularization multiplier"
names(res)[names(res) == "auc.train"] <- "Training AUC"
names(res)[names(res) == "auc.val.avg"] <- "Mean testing AUC"
names(res)[names(res) == "AICc"] <- "AICc"
names(res)[names(res) == "delta.AICc"] <- "Delta AICc"
names(res)[names(res) == "ncoef"] <- "Parameters"
knitr::kable(res[,c(1,2,4,8,16,17,19)], "simple", digits = 2)
```


### Select models with lowest AICc and highest mean testing AUC. In this case, a single model has both features
Lowest AICc
```{r echo=FALSE, message=FALSE, warning=FALSE}
res1 <- res[which.min(res$AICc),]
knitr::kable(res1[,c(1,2,4,8,16,17,19)], "simple", digits = 2)
```

Highest mean testing AUC
```{r echo=FALSE, message=FALSE, warning=FALSE}
res2 <- res[which.max(res[,8]),]
knitr::kable(res2[,c(1,2,4,8,16,17,19)], "simple", digits = 2)
```


### TSS metrics are calculated for the following subsets:
- Complete set of original training data from around the globe, except Europe (Train)
- Data from Europe (withheld from cross-validation training and testing, Test)
```{r echo=FALSE, message=FALSE, warning=FALSE}
model1 <- eval.models(e.mx.l)[[res1$tune.args]]
```

```{r echo=TRUE, message=FALSE, warning=FALSE}
e_2train = evaluate(pres_train, backg_train, model1, modelEnv)
e_2test = evaluate(pres_test, backg_test, model1, modelEnv)

e_2tss_train <- max(e_2train@TPR + e_2train@TNR) - 1
e_2tss_test <- max(e_2test@TPR + e_2test@TNR) - 1
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
table <- data.frame("Model"=c("Selected model"), 
                    "TSS train"=c(e_2tss_train), 
                    "TSS test"=c(e_2tss_test))

knitr::kable((table), "simple", digits = 2)
```

### Plot response curves for best model

BIO 1 = mean annual temperature

BIO 7 = annual temperature variation

Bio 17 = precipitation of driest quarter

```{r echo=TRUE, message=FALSE, warning=FALSE}
plot(model1, type = "cloglog", 
     ylab=tools::toTitleCase("Suitability"))
```

```{r message=FALSE, warning=FALSE, include=FALSE}
dev.off()
```

### Plot model predictions
```{r echo=FALSE, message=FALSE, warning=FALSE}
pred.seq <- eval.predictions(e.mx.l)[[res1$tune.args]]
plot(pred.seq, Main = "Predicted habitat suitability for L. punctata")
```


### Add occurrence (training data) and background points to prediction plot
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(pred.seq, main = "Predicted habitat suitability for L. punctata")
points(eval.bg(e.mx.l), pch = 3, col = eval.bg.grp(e.mx.l), cex = 0.5)
points(eval.occs(e.mx.l), pch = 21, bg = eval.occs.grp(e.mx.l))
legend("bottomright", legend=c("Occurrence data (colors are spatial blocks)", "Background points"),
       cex=0.8, pch = c(1,3))
```


### Model predictions for Europe
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(pred.seq, main = "Predicted habitat suitability for L. punctata in Europe",
     xlim=c(-10.6600,31.5500), ylim=c(34.5000,71.0500))
```


### Model predictions for Canada
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(pred.seq, main = "Predicted habitat suitability for L. punctata in the Great Lakes Region",
     xlim = c(-100, -50), ylim = c(30, 60))
```


### Model predictions for North America
```{r echo=FALSE, message=FALSE, warning=FALSE}
plot(pred.seq, main = "Predicted habitat suitability for L. punctata in North America",
     xlim=c(-150,-50),ylim=c(20,90))
```
