---
title: "Dotted duckweed maxent study: Models using future air temperatures (rmd file #4)"
author: "Debora"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
Sys.setenv('R_MAX_VSIZE'=3200000000000)
memory.limit(24000000)

options(java.parameters="~xmx20g")
library(raster)
library(maptools)
library(dismo)
library(maps)
library(rJava)
library(ENMeval)
library(maxnet)
library(rTPC)
library(nls.multstart)
library(sp)
library(kableExtra)
library(ENMeval)

.jinit()

knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

### Load occurrence datasets previously cleaned up and sampled
```{r include=FALSE}
#setwd("C:/Users/user/Desktop/maxent_polished")

pres_train <- read.csv("pres_train.csv") #training dataset (world records)
pres_test <- read.csv("pres_test.csv") #testing dataset (Europe records: exact and inexact coordinates)
pres_test_sure <- read.csv("pres_test_sure.csv") #testing dataset (Europe records: exact locations only)
coordinates(pres_train) <- ~lon + lat
coordinates(pres_test) <- ~lon + lat
full_dataset <- rbind(pres_train,pres_test)
```

### Load future air temperature raster
```{r echo=TRUE, message=FALSE, warning=FALSE}
air_future <- raster::getData('CMIP5', var='bio', res=2.5, rcp=45, model='MI', year=70)
air_future <- raster::brick(air_future)
```

### Subset raster to correspond to the pre-selected bioclimatic variables
```{r}
air_future <- air_future[[c(1,7,19)]]
```

### Increase spatial resolution to correspond to resolution previously applied to raster of observation records
```{r}
air_future <- disaggregate(air_future, fact=1.602564231)
```

### Crop environment to correspond to species distribution range
```{r message=FALSE, warning=FALSE}
model.extent<-extent(min(full_dataset$lon)-10,max(full_dataset$lon)+10,
                     min(full_dataset$lat)-10,max(full_dataset$lat)+10)
air_future <- crop(air_future,model.extent)

saveRDS(air_future,"air_future_crop.rds")
```

### Create buffer around occurrence area and create study area 
```{r echo=TRUE, message=FALSE, warning=FALSE}
occ_buff <- buffer(pres_train,600000, dissolve=TRUE) #width parameter=600000m = 600km

# crop study area to buffer extent
studyArea <- crop(air_future,extent(occ_buff))  

# mask the non buffer areas
studyArea <- mask(studyArea,occ_buff)
# output will still be a raster stack, just of the study area

# check with plot
plot(studyArea[[1]]/10, main="Buffer areas and observation points") 
points(pres_train$lon, pres_train$lat, pch=1, cex=0.51, col="purple")
legend("bottomright",legend=c("Buffer areas: annual mean temperature coloring", 
                            "Occurrences: purple"))
```

### Randomly sample points 
Sample same number as our observed points inside the buffer to create pseudo-absences, or hypothetical areas where species could either be found or not
```{r echo=TRUE, message=FALSE, warning=FALSE}
set.seed(2022)
backg = randomPoints(studyArea, n=708, p=pres_train, extf=1)
colnames(backg) <- c("lon","lat")
```

### Divide background dataset into training and testing
```{r echo=TRUE, message=FALSE, warning=FALSE}
group=kfold(backg, 5)
backg_train <- backg[group!=1,]
backg_test <- backg[group==1,]

write.csv(backg_train,"backg_train_air_future.csv",row.names=FALSE)
write.csv(backg_test,"backg_test_air_future.csv",row.names=FALSE)
```

### Run candidate models
```{r}
e.mx.l.air.future <- ENMevaluate(occs = pres_train, envs = air_future, bg = backg_train,
                        occs.testing = pres_test,
                        algorithm = 'maxent.jar', partitions = 'block', 
                        tune.args = list(fc = c("L","LQ"), rm = seq(0.5, 4, by = 0.5)))

saveRDS(e.mx.l.air.future,"e.mx.l.air.future.rds")
```

### Calculate TSS
```{r}
aic <- eval.results(e.mx.l.air.future)
res_best <- aic[which.min(aic$AICc),]
model1 <- eval.models(e.mx.l.air.future)[[res_best$tune.args]]

e_2train = evaluate(pres_train, backg_train, model1, air_future)

e_2test = evaluate(pres_test, backg_test, model1, air_future)

e_2auc_train <- e_2train@auc
e_2auc_test <- e_2test@auc
e_2auc_train  
e_2auc_test

e_2tss_train <- max(e_2train@TPR + e_2train@TNR) - 1
e_2tss_test <- max(e_2test@TPR + e_2test@TNR) - 1
e_2tss_train  
e_2tss_test

e_europe_sure = evaluate(pres_test_sure, backg_test, model1, air_future)

e_2auc_europe_sure <- e_europe_sure@auc
e_2auc_europe_sure  
e_2tss_europe_sure <- max(e_europe_sure@TPR + e_europe_sure@TNR) - 1
e_2tss_europe_sure
```


### Plot prediction maps
```{r}
europe_lit_unreported <- data.frame(lon=c(4.47,0.11,12.57,12.57,6.14,24.94,18.3),lat=c(50.5,51.5,41.87,41.87,46.2,60.19,59.2))
europe_GBIF <- read.csv("europe_GBIF.csv")
world <- read.csv("world.csv")

pred.seq.future <- eval.predictions(e.mx.l.air.future)[[res_best$tune.args]]

plot(pred.seq.future, xlim=c(-20,31.5500), ylim=c(34.5000,71.0500), xlab = "Longitude", ylab= "Latitude")
  points(jitter(europe_GBIF$lon,200),jitter(europe_GBIF$lat,200), pch = 20, cex = 1.5)
  points(jitter(europe_lit_unreported$lon,2),jitter(europe_lit_unreported$lat,2), pch = 20, cex = 1.5, col="#D55E00")
legend("topleft", legend=c("Exact occurrences", "Approximate occurrences"), 
         col=c("black", "#D55E00"), pch = 20, cex = 1)

plot(pred.seq.future, xlim=c(-135,-50),ylim=c(16,90),xlab="Longitude",ylab="Latitude")
legend("topleft", legend="Occurrence records", cex=1, pch = 20)
points(world$lon,world$lat, pch = 20, cex = 1.5)
```