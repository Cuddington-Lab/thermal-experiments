---
title: "Can maxent distribution models predict physiological responses from thermal tolerance?"
author: "Debora"
date: "`r Sys.Date()`"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(maptools)
library(sp)
library(dismo)
```

## Definition of the maximum entropy method
The maximum entropy (MaxEnt) method models the distribution of species. It matches environmental variables with observation records and then calculates probabilities of habitat suitability based on environmental conditions found in each location (Phillips et al. 2006).

## *Lemna minor* distribution data was downloaded from GBIF, cleaned up, and saved in our lab repository
Details:
Download date: 19 July 2023
Download link: https://doi.org/10.15468/dl.rb74r2
Duplicates in the same latitude/longitude: removed
Type of record: observation (no herbarium records)
NA data (latitude/longitude): removed

```{r}
lemna_GBIF <- read.csv("https://raw.githubusercontent.com/Cuddington-Lab/thermal-experiments/main/distribution/lemna_GBIF.csv",header=TRUE, stringsAsFactors = TRUE,fileEncoding="UTF-8-BOM")
```

## Visualize distribution data
```{r}
data(wrld_simpl)
plot(wrld_simpl, axes=TRUE, col="light yellow")
# add observation points
points(lemna_GBIF$lon, lemna_GBIF$lat, col='orange', pch=20, cex=0.75)
points(lemna_GBIF$lon, lemna_GBIF$lat, col='red', cex=0.75)
```

## Transform dataframe into spatial points dataframe
```{r}
coordinates(lemna_GBIF) <- ~lon+lat
crs(lemna_GBIF) <- crs(wrld_simpl)
class(lemna_GBIF)
```

## To reduce sampling bias (disproportional reporting in some areas), a single observation was sampled for each 2.5 arc min 
```{r}
# create a raster layer with the same extent as my data
r <- raster(lemna_GBIF)
# set resolution of cells to 0.4166 degrees (equivalent to 2.5 arc min)
res(r) <- 0.4166
# sample 1 observation per area
lemna_GBIF_sp <- gridSample(lemna_GBIF, r, n=1)
```

## Divide file into 5 parts. 75% will be used to train the model, and 25% will be used to test it
```{r}
group <- kfold(lemna_GBIF_sp,5)
pres_train <- lemna_GBIF_sp[group!=1,]
pres_test <- lemna_GBIF_sp[group==1,]
```

## Get climate data from WorldClim
```{r}
climate=getData("worldclim", var="bio",res=2.5)
```

## Maxent modeling using bioclimatic variables and 75% of the occurrence data to train the model
```{r warning=FALSE}
library(rJava)
.jinit()
set.seed(202307)
xm <- maxent(climate,pres_train)
plot(xm)
# description of bioclimatic variables: https://www.worldclim.org/data/bioclim.html
```

## Create pseudo-absences (hypothetical areas where species was not found), divide data into 5
```{r}
backg = randomPoints(climate, n=1000, extf=1.25)
colnames(backg) <- c("lon","lat")
group=kfold(backg, 5)
backg_train <- backg[group!=1,]
backg_test <- backg[group==1,]
```

## Evaluate model using test data, absence data, maxent model, and bioclimatic variables
AUC values above ~0.8 indicate acceptable models (varies from no-better-than-random (0.5) to perfect (1))
```{r}
e = evaluate(pres_test, backg_test, xm, climate)
plot(e,'ROC')
```

## Plot maxent model predictions for the habitat suitability of duckweeds
```{r}
p <- predict(climate, xm, progress='')
plot(p, main="Maxent model for duckweed distribution: all climatic variables included")
```

## Check correlation between climatic variables
```{r}
stats <- layerStats(climate, 'pearson', na.rm=T)
corr_matrix <- stats$'pearson correlation coefficient'
corr_matrix

subset(as.data.frame.table(cor(corr_matrix)), Freq < 1 & Freq > 0.8)
#removing bio3, bio5, bio6, bio8, bio9, bio10, bio 11, bio2 
#bio1 is my most important variable, so I am excluding others

climate_drop <- dropLayer(climate, c(2, 3, 5, 6, 8, 9, 10, 11))
```

## Re-run model excluding correlated variables
```{r}
xm2 <- maxent(climate_drop,pres_train)
plot(xm2)
e2 = evaluate(pres_test, backg_test, xm2, climate_drop)
plot(e2,'ROC')
p2 <- predict(climate_drop, xm2, progress='')
plot(p2, main="Maxent model for duckweed distribution after excluding climatic variables")
```

## Model assessment
```{r}
library(rmaxent)
ic(stack(p, p2), 
   lemna_GBIF_sp, list(xm, xm2))
```
The model including all climatic variables has a better score.

## Clip WorldClim temperature variable (bio1 = mean annual temperature) to include minimum and maximum temperature tolerance from duckweed thermal performance curve
```{r}
r <- getData("worldclim",var="bio",res=10)
r <- r[[(1)]]

#divide by ten to get Celsius
r = r/10

#crop temperature data based on CTmin and CTmax from thermal performance curve obtained during experiments
r <- setMinMax()
r = r > 0 & r < 43.99

r = r*10

e <- extent(r)
```

## Predict and plot distribution based on all climatic variables and thermal tolerance of duckweeds
```{r}
climate_crop <- crop(climate,e)

xm3 <- maxent(climate_crop,pres_train)
plot(xm3)
e3 = evaluate(pres_test, backg_test, xm3, climate_crop)
plot(e3,'ROC')
p3 <- predict(climate_crop, xm3, progress='')
plot(p3, main="Maxent model for duckweed distribution")
```


## References
Phillips, S. J., Anderson, R. P., & Schapire, R. E. (2006). Maximum entropy modeling of species geographic distributions. *Ecological modelling, 190*(3-4), 231-259.

## Good tutorials
https://rspatial.org/raster/sdm/2_sdm_occdata.html
https://rfunctions.blogspot.com/2020/10/modelling-effects-of-climate-change.html

