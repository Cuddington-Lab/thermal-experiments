---
title: "Dotted duckweed maxent study: Models using current lake temperatures (rmd file #2)"
author: "Debora"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
Sys.setenv('R_MAX_VSIZE'=3200000000000)
memory.limit(24000000)

options(java.parameters="~xmx20g")
library(raster)
library(maptools)
library(dismo)
library(maps)
library(rJava)
library(ENMeval)
library(maxnet)
library(rTPC)
library(nls.multstart)
library(sp)
library(kableExtra)
library(ENMeval)

.jinit()

knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

### Load occurrence datasets previously cleaned up and sampled
```{r include=FALSE}
setwd("C:/Users/user/Desktop/maxent_polished")

pres_train <- read.csv("pres_train.csv") #training dataset (world records)
pres_test <- read.csv("pres_test.csv") #testing dataset (Europe records: exact and inexact coordinates)
pres_test_sure <- read.csv("pres_test_sure.csv") #testing dataset (Europe records: exact locations only)
coordinates(pres_train) <- ~lon + lat
coordinates(pres_test) <- ~lon + lat
full_dataset <- rbind(pres_train,pres_test)
```

### Load current lake temperature raster
Downloaded from:  https://doi.org/10.1111/ecog.06595 (Armitage, 2023)
```{r echo=TRUE, message=FALSE, warning=FALSE}
lake <- raster::brick('bioclim_lakes_10km.tif')
```

### Subset raster to correspond to the pre-selected bioclimatic variables
```{r}
lake <- lake[[c(1,7,19)]]
```

### Increase spatial resolution to correspond to resolution previously applied to raster of observation records
```{r}
lake <- disaggregate(lake, fact=3.2)
```

### Crop environment to correspond to species distribution range
```{r message=FALSE, warning=FALSE}
model.extent<-extent(min(full_dataset$lon)-10,max(full_dataset$lon)+10,
                     min(full_dataset$lat)-10,max(full_dataset$lat)+10)

lake <- crop(lake,model.extent)

saveRDS(lake,"lake_crop.rds")
```

### Create buffer around occurrence area and create study area 
```{r echo=TRUE, message=FALSE, warning=FALSE}
occ_buff <- buffer(pres_train,600000, dissolve=TRUE) #width parameter=600000m = 600km

# crop study area to buffer extent
studyArea <- crop(lake,extent(occ_buff))  

# mask the non buffer areas
studyArea <- mask(studyArea,occ_buff)
# output will still be a raster stack, just of the study area

# check with plot
plot(studyArea[[1]]/10, main="Buffer areas and observation points") 
points(pres_train$lon, pres_train$lat, pch=1, cex=0.51, col="purple")
legend("bottomright",legend=c("Buffer areas: annual mean temperature coloring", 
                            "Occurrences: purple"))
```

### Randomly sample points 
Sample same number as our observed points inside the buffer to create pseudo-absences, or hypothetical areas where species could either be found or not
```{r echo=TRUE, message=FALSE, warning=FALSE}
set.seed(2022)
backg = randomPoints(studyArea, n=708, p=pres_train, extf=1)
colnames(backg) <- c("lon","lat")
```

### Divide background dataset into training and testing
```{r echo=TRUE, message=FALSE, warning=FALSE}
group=kfold(backg, 5)
backg_train <- backg[group!=1,]
backg_test <- backg[group==1,]

write.csv(backg_train,"backg_train_lake.csv",row.names=FALSE)
write.csv(backg_test,"backg_test_lake.csv",row.names=FALSE)
```

### Run candidate models
```{r}
e.mx.l.lake <- ENMevaluate(occs = pres_train, envs = lake, bg = backg_train,
                        occs.testing = pres_test,
                        algorithm = 'maxent.jar', partitions = 'block', 
                        tune.args = list(fc = c("L","LQ"), rm = seq(0.5, 4, by = 0.5)))

saveRDS(e.mx.l.lake,"e.mx.l.lake.rds")

aic <- eval.results(e.mx.l.lake)
res_best <- aic[which.min(aic$AICc),]
model1 <- eval.models(e.mx.l.lake)[[res_best$tune.args]]

e_2train = evaluate(pres_train, backg_train, model1, lake)

e_2test = evaluate(pres_test, backg_test, model1, lake)

e_2auc_train <- e_2train@auc
e_2auc_test <- e_2test@auc
e_2auc_train  
e_2auc_test

e_2tss_train <- max(e_2train@TPR + e_2train@TNR) - 1
e_2tss_test <- max(e_2test@TPR + e_2test@TNR) - 1
e_2tss_train  
e_2tss_test

e_europe_sure = evaluate(pres_test_sure, backg_test, model1, lake)

e_2auc_europe_sure <- e_europe_sure@auc
e_2auc_europe_sure  
e_2tss_europe_sure <- max(e_europe_sure@TPR + e_europe_sure@TNR) - 1
e_2tss_europe_sure
```
